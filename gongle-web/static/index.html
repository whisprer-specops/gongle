<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Gongle - Where your data goes to party before being sold!</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#333;min-height:100vh;position:relative}
    .homepage{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;text-align:center}
    .logo{font-size:90px;margin-bottom:20px;cursor:pointer;transition:transform .3s;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .logo:hover{transform:scale(1.05)}
    .logo span:nth-child(1){color:#4285f4}.logo span:nth-child(2){color:#ea4335}.logo span:nth-child(3){color:#fbbc05}
    .logo span:nth-child(4){color:#4285f4}.logo span:nth-child(5){color:#34a853}.logo span:nth-child(6){color:#ea4335}
    .tagline{font-size:18px;color:#fff;margin-bottom:30px;text-shadow:1px 1px 2px rgba(0,0,0,.5)}
    .search-container{width:100%;max-width:600px;margin-bottom:30px}
    .search-box{width:100%;border:2px solid #dfe1e5;border-radius:24px;padding:15px 20px;font-size:16px;outline:none;transition:box-shadow .3s;background:rgba(255,255,255,.9)}
    .search-box:focus{box-shadow:0 1px 6px rgba(32,33,36,.28);border-color:#4285f4}
    .btn{background:linear-gradient(45deg,#4285f4,#34a853);color:#fff;border:none;padding:15px 30px;font-size:16px;border-radius:25px;cursor:pointer;margin:10px;font-weight:bold;text-transform:uppercase;box-shadow:0 4px 15px rgba(0,0,0,.2);transition:all .3s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
    .modal.active{display:flex;align-items:center;justify-content:center}
    .modal-content{background:#fff;padding:30px;border-radius:15px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 40px rgba(0,0,0,.2)}
    .email-input{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;margin-bottom:12px}
    .status-message{margin-top:10px;padding:10px;border-radius:8px;display:none}
    .status-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .status-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .page-progress{background:#e9ecef;height:6px;border-radius:3px;margin:20px 0;overflow:hidden}
    .progress-bar{background:linear-gradient(45deg,#4285f4,#34a853);height:100%;border-radius:3px;transition:width .5s}
    .connection-status{position:fixed;top:20px;right:20px;padding:10px 15px;border-radius:20px;font-size:14px;font-weight:bold;z-index:2000}
    .connection-online{background:#d4edda;color:#155724}
    .connection-offline{background:#f8d7da;color:#721c24}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    .dashboard{display:none;max-width:1000px;margin:0 auto;padding:30px}
    .dashboard.active{display:block}
    .dashboard-header{background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.12)}
    .page{display:none;background:#fff;margin:20px 0;padding:20px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.12)}
    .page.active{display:block}
    .data-input{width:70%;padding:10px;border-radius:8px;border:1px solid #ccc;margin:8px 8px 8px 0}
    .data-btn{padding:10px 16px;border:none;border-radius:8px;background:#4285f4;color:#fff;cursor:pointer}
    .bonus-btn{margin-top:12px;background:#ffc107;color:#333}
    .leaderboard{background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.12)}
    .leaderboard ul{list-style:none}
    .leaderboard li{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #eee}
    .leaderboard li:last-child{border-bottom:none}
  </style>
</head>
<body>
  <div id="connectionStatus" class="connection-status connection-offline">Flask Server Not Connected</div>

  <!-- landing -->
  <div class="homepage" id="landing">
    <div class="logo" onclick="showConsent()"><span>G</span><span>o</span><span>n</span><span>g</span><span>l</span><span>e</span></div>
    <div class="tagline">Where your data goes to party before being sold!</div>
    <div class="search-container">
      <input class="search-box" placeholder="How much of you will you sell today?" onclick="showConsent()" readonly />
    </div>
    <button class="btn" onclick="showConsent()">Enter Gongle</button>
    <p style="color:#fff;margin-top:20px;font-style:italic">"The only search engine that's honest about harvesting your data!"</p>
  </div>

  <!-- consent modal -->
  <div class="modal" id="consentModal">
    <div class="modal-content">
      <h2>GONGLE DATA HARVESTING AGREEMENT</h2>
      <p><strong>Last Updated: Right Now</strong></p>
      <h4>WHAT WE DO</h4>
      <p>Gongle is a satirical data collection platform that explicitly monetizes user-provided personal information.</p>
      <h4>YOUR DATA RIGHTS</h4>
      <ul>
        <li>Your data may be collected and “sold” for the game</li>
        <li>You get points in return</li>
        <li>This is for entertainment/education</li>
      </ul>
      <h4>THE THEATER</h4>
      <p>Security theater features are for satire.</p>
      <div class="checkbox-container" style="display:grid;gap:8px;margin:14px 0">
        <label><input type="checkbox" id="consent1" /> I understand this is satire</label>
        <label><input type="checkbox" id="consent2" /> I agree to play</label>
        <label><input type="checkbox" id="consent3" /> I acknowledge the irony</label>
      </div>
      <div style="text-align:center">
        <button class="btn" onclick="agreeToTerms()">I Agree - Let's Play</button>
        <button class="btn" onclick="closeModal()" style="background:#666;margin-left:10px">Back</button>
      </div>
    </div>
  </div>

  <!-- email modal -->
  <div class="modal" id="emailModal">
    <div class="modal-content">
      <h2>Join the Data Circus</h2>
      <p style="margin-bottom:12px">Enter your email to start</p>
      <input type="email" id="emailInput" class="email-input" placeholder="your@email.com" required />
      <div id="emailStatus" class="status-message"></div>
      <div style="text-align:center;margin-top:10px">
        <button class="btn" onclick="submitEmail()">Create Account</button>
        <button class="btn" onclick="closeModal()" style="background:#666;margin-left:10px">Back</button>
      </div>
    </div>
  </div>

  <!-- dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="dashboard-header">
      <h2>Welcome to the Data Marketplace, <span id="username">User</span>!</h2>
      <div class="points-display"><span id="points">0</span> Points</div>
      <p style="margin-top:10px">Current Stage: <span id="currentStage">Basic Info</span></p>
      <div class="page-progress"><div class="progress-bar" id="progressBar" style="width:20%"></div></div>
    </div>

    <!-- page 1 -->
    <div class="page active" id="page1">
      <h3>Basic Info Buffet</h3>
      <p style="margin-bottom:20px;color:#666">Let's start with the appetizers.</p>
      <div><input class="data-input" id="ip_address" placeholder="Your IP (auto-collected)" disabled /><button class="data-btn" data-type="ip_address" onclick="sellData('ip_address','IP Address',10,false)">Sell IP (10 pts)</button></div>
      <div><input class="data-input" id="browser" placeholder="Browser (auto)" disabled /><button class="data-btn" data-type="browser" onclick="sellData('browser','Browser',5,false)">Sell Browser (5 pts)</button></div>
      <div><input class="data-input" id="location" placeholder="City, Country" /><button class="data-btn" data-type="location" onclick="sellData('location','Location',20,true)">Sell Location (20 pts)</button></div>
      <div><input class="data-input" id="favorite_food" placeholder="Favorite Food" /><button class="data-btn" data-type="favorite_food" onclick="sellData('favorite_food','Favorite Food',60,true)">Favorite Food (60 pts)</button></div>
      <div><input class="data-input" id="favorite_movie" placeholder="Favorite Movie" /><button class="data-btn" data-type="favorite_movie" onclick="sellData('favorite_movie','Favorite Movie',70,true)">Favorite Movie (70 pts)</button></div>
      <button class="bonus-btn btn" id="bonus1" data-bonus-page="page1" data-bonus-points="300" disabled>Claim 300pt Completion Bonus</button>
    </div>

    <!-- page 2 -->
    <div class="page" id="page2">
      <h3>Mid-Tier Info (Page 2)</h3>
      <p>Getting warmer…</p>
      <div><input class="data-input" id="phone_number" placeholder="Phone Number" /><button class="data-btn" data-type="phone_number" onclick="sellData('phone_number','Phone Number',100,true)">Phone Number (100 pts)</button></div>
      <div><input class="data-input" id="twitter_handle" placeholder="Twitter/X Handle" /><button class="data-btn" data-type="twitter_handle" onclick="sellData('twitter_handle','Twitter Handle',80,true)">Twitter Handle (80 pts)</button></div>
      <div><input class="data-input" id="instagram_username" placeholder="Instagram Username" /><button class="data-btn" data-type="instagram_username" onclick="sellData('instagram_username','Instagram Username',85,true)">Instagram Username (85 pts)</button></div>
      <div><input class="data-input" id="facebook_name" placeholder="Facebook Name" /><button class="data-btn" data-type="facebook_name" onclick="sellData('facebook_name','Facebook Name',1000,true)">Facebook Name (1000 pts)</button></div>
      <div><input class="data-input" id="occupation" placeholder="Your Job/Occupation" /><button class="data-btn" data-type="occupation" onclick="sellData('occupation','Occupation',100,true)">Occupation (100 pts)</button></div>
      <button class="bonus-btn btn" id="bonus2" data-bonus-page="page2" data-bonus-points="500" disabled>Claim 500pt Completion Bonus</button>
    </div>

        <!-- page 3 -->
        <div class="page" id="page3">
      <h3>High-Value Info (Page 3)</h3>
      <p>Now it gets profitable…</p>
        
      <div>
        <input class="data-input" id="credit_card_last4" placeholder="Credit Card Last 4 Digits" />
        <button class="data-btn" data-type="credit_card_last4" data-label="Credit Card Last 4" data-points="200" data-needs-input="true">Credit Card Last 4 (200 pts)</button>
      </div>
    
      <div>
        <input class="data-input" id="annual_income" placeholder="Annual Income" />
        <button class="data-btn" data-type="annual_income" data-label="Annual Income" data-points="250" data-needs-input="true">Annual Income (250 pts)</button>
      </div>
    
      <div>
        <input class="data-input" id="medical_conditions" placeholder="Medical Conditions" />
        <button class="data-btn" data-type="medical_conditions" data-label="Medical Conditions" data-points="500" data-needs-input="true">Medical Conditions (500 pts)</button>
      </div>
    
      <div>
        <input class="data-input" id="political_affiliation" placeholder="Political Views" />
        <button class="data-btn" data-type="political_affiliation" data-label="Political Affiliation" data-points="1850" data-needs-input="true">Political Affiliation (1850 pts)</button>
      </div>
    
      <div>
        <input class="data-input" id="mothers_maiden" placeholder="Mother's Maiden Name" />
        <button class="data-btn" id="btn_mothers_maiden"
                data-type="mothers_maiden"
                data-label="Mother's Maiden Name"
                data-points="2500"
                data-needs-input="true">Mother’s Maiden Name (2500 pts)</button>
      </div>
    
          <div>
      <button
        class="bonus-btn btn"
        id="bonus3"
        data-bonus-page="page3"
        data-bonus-points="900"
        disabled
      >Claim 900pt Completion Bonus</button>
    </div>
    </div>

    <!-- page 4 -->
    <div class="page" id="page4">
      <h3>Extreme Secrets (Page 4)</h3>
      <p>We definitely shouldn’t be asking this.</p>
      <div><input class="data-input" id="ssn_full" placeholder="Full SSN / Nat. ID" /><button class="data-btn" data-type="ssn_full" onclick="sellData('ssn_full','Full SSN',5000,true)">Full SSN (5000 pts)</button></div>
      <div><input class="data-input" id="full_credit_card" placeholder="Full Credit Card Number" /><button class="data-btn" data-type="full_credit_card" onclick="sellData('full_credit_card','Full Credit Card',7000,true)">Full Credit Card (7000 pts)</button></div>
      <div><input class="data-input" id="dna_results" placeholder="DNA Results Summary" /><button class="data-btn" data-type="dna_results" onclick="sellData('dna_results','DNA Results',4000,true)">DNA Results (4000 pts)</button></div>
      <div><input class="data-input" id="bank_account_full" placeholder="Full Bank Account" /><button class="data-btn" data-type="bank_account_full" onclick="sellData('bank_account_full','Bank Account',6500,true)">Bank Account (6500 pts)</button></div>
      <div><input class="data-input" id="all_passwords" placeholder="All Passwords (don’t!)" /><button class="data-btn" data-type="all_passwords" onclick="sellData('all_passwords','All Passwords',9999,true)">All Passwords (9999 pts)</button></div>
      <div><input class="data-input" id="deepest_fear" placeholder="Deepest Fear" /><button class="data-btn" data-type="deepest_fear" onclick="sellData('deepest_fear','Deepest Fear',10,true)">Deepest Fear (10 pts)</button></div>
      <button class="bonus-btn btn" id="bonus4" data-bonus-page="page4" data-bonus-points="1500" disabled>Claim 1500pt Completion Bonus</button>
    </div>

    <!-- page 5 -->
    <div class="page" id="page5">
      <h3>Data Protection Theater (Page 5)</h3>
      <p>Congrats. You finished the Gongle experience.</p>
      <div class="completion-section" style="background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;padding:30px;margin:20px 0;border-radius:15px;text-align:center">
        <h3>Congratulations</h3>
        <p style="font-size:18px;margin:20px 0">You completed the Gongle experience.</p>
        <button class="btn" onclick="window.alert('Your Master Certificate is totally real.')">Generate Master Certificate</button>
      </div>

      <div class="leaderboard">
        <h3>Data Selling Champions</h3>
        <ul id="leaderboard"><li>Loading leaderboard…</li></ul>
      </div>
    </div>
  </div>

  <!-- single, consolidated script (no duplicates, no shadowing) -->
  <script>
    // ---- single source of truth ----
    let serverConnected = false;
    let currentPage = 1;
    let userPoints = 0;
    const soldData = new Set();
    const sessionStart = new Date();

    const PAGE_REQ = {
      page1: ['ip_address','browser','location','favorite_food','favorite_movie'],
      page2: ['phone_number','twitter_handle','instagram_username','facebook_name','occupation'],
      page3: ['credit_card_last4','annual_income','medical_conditions','political_affiliation','mothers_maiden'],
      page4: ['ssn_full','full_credit_card','dna_results','bank_account_full','all_passwords','deepest_fear'],
      page5: []
    };

    // ---- connection indicator ----
    function pingServer(){
      fetch('/api/health')
        .then(r => r.json())
        .then(() => updateConn(true))
        .catch(() => updateConn(false));
    }
    function updateConn(ok){
      serverConnected = ok;
      const el = document.getElementById('connectionStatus');
      if (!el) return;
      el.textContent = ok ? 'Flask Server Connected' : 'Flask Server Not Connected';
      el.className = 'connection-status ' + (ok ? 'connection-online' : 'connection-offline');
    }

    // ---- start / consent / email ----
    function showConsent(){
      // don’t hard-block entry if ping is a tad slow — just warn once
      if (!serverConnected) {
        alert('Flask server has not replied yet. I will still open the consent; please ensure backend is running.');
      }
      document.getElementById('consentModal').classList.add('active');
    }
    function closeModal(){
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    }
    function agreeToTerms(){
      const ok = ['consent1','consent2','consent3'].every(id => document.getElementById(id).checked);
      if (!ok) { alert('Please check all three boxes.'); return; }
      closeModal();
      document.getElementById('emailModal').classList.add('active');
    }
    function submitEmail(){
      const email = document.getElementById('emailInput').value.trim();
      const status = document.getElementById('emailStatus');
      function setStatus(t, kind){ status.textContent=t; status.className='status-message status-' + kind; status.style.display='block'; }
      if (!email || !email.includes('@')) { setStatus('Please enter a valid email.','error'); return; }
      setStatus('Creating / restoring your account…','success');

      fetch('/api/create_account',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})})
        .then(r=>r.json())
        .then(data=>{
          if (!data.success){ setStatus(data.error || 'Failed to create account.','error'); return; }

          document.getElementById('username').textContent = email.split('@')[0];
          userPoints = data.points || 0;
          document.getElementById('points').textContent = userPoints;

          closeModal();
          document.getElementById('landing').style.display='none';
          document.getElementById('dashboard').classList.add('active');

          // hydrate and jump to server’s notion of progress
          hydrateUserState().then(() => {
            const target = Number(data.current_page || 1);
            advanceToPage(target);
          });
        })
        .catch(()=> setStatus('Backend unreachable. Is Flask running?','error'));
    }

    async function hydrateUserState(){
      try{
        const r = await fetch('/api/debug/user_state');
        if (!r.ok) return;
        const data = await r.json();
        if (data.error) return;
      
        // points
        if (typeof data.points === 'number') {
          userPoints = data.points;
          document.getElementById('points').textContent = userPoints;
        }
      
        // reset all data-btns to enabled; we’ll disable the sold ones
        document.querySelectorAll('.data-btn').forEach(b => b.removeAttribute('disabled'));
      
        // clear and reapply sold set
        soldData.clear();
        (data.data_types_sold || []).forEach(t=>{
          soldData.add(t);
          const b = document.querySelector(`.data-btn[data-type="${t}"]`);
          if (b){ b.setAttribute('disabled','disabled'); b.textContent='Sold!'; b.style.background='#ccc'; }
        });
      
        // mark claimed bonuses
        const claimed = new Set((data.bonuses_claimed || []).map(b => String(b.page)));
        for (let p = 1; p <= 5; p++){
          const id = 'bonus'+p;
          const btn = document.getElementById(id);
          if (!btn) continue;
        
          const pageKey = 'page'+p;
          if (claimed.has(pageKey)) {
            btn.disabled = true;
            btn.textContent = 'CLAIMED!';
            btn.style.background = '#28a745';
            btn.style.animation = 'none';
          } else {
            // not yet claimed: enable only if page complete
            const need = PAGE_REQ[pageKey] || [];
            const done = need.every(t => soldData.has(t));
            btn.disabled = !done;
            if (done) {
              btn.style.background = '#ffc107';
              btn.style.animation = 'pulse 1s infinite';
            } else {
              btn.style.background = '';
              btn.style.animation = 'none';
            }
          }
        }
      }catch(_){}
    }

    // ---- selling data ----
    function sellData(type,label,points,needsInput){
      const btn = document.querySelector(`button[data-type="${type}"]`);
      const input = document.getElementById(type);
      const value = needsInput ? (input?.value || '').trim() : '';
      if (needsInput && !value){ alert(`Please enter ${label}.`); return; }
      if (btn) btn.disabled = true;

      fetch('/api/sell',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type, value})})
        .then(r=>r.json())
        .then(data=>{
          if (!data.success){
            alert(data.error || 'Sell failed');
            if (btn) btn.disabled = false;
            return;
          }
          soldData.add(type);
          userPoints = data.points || userPoints;
          document.getElementById('points').textContent = userPoints;
          if (btn){ btn.textContent='Sold!'; btn.style.background='#ccc'; }
          checkPageCompletion();
        })
        .catch(()=>{ alert('Connection error.'); if (btn) btn.disabled=false; });
    }

        function checkPageCompletion(){
      const need = PAGE_REQ['page'+currentPage] || [];
      const done = need.every(t => soldData.has(t));
        
      const bonusBtn = document.getElementById('bonus'+currentPage);
      if (!bonusBtn) return;
        
      const alreadyClaimed = /CLAIMED!/i.test(bonusBtn.textContent);
      if (alreadyClaimed) {
        bonusBtn.disabled = true;
        bonusBtn.style.background = '#28a745';
        bonusBtn.style.animation = 'none';
        return;
      }
    
      bonusBtn.disabled = !done;
      if (done) {
        bonusBtn.style.background = '#ffc107';
        bonusBtn.style.animation = 'pulse 1s infinite';
      } else {
        bonusBtn.style.background = '';
        bonusBtn.style.animation = 'none';
      }
    }

    function claimBonus(page,points){
      const btn = document.getElementById('bonus'+String(page).replace('page',''));
      if (btn) btn.disabled = true;

      fetch('/api/claim_bonus',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({page,points})})
        .then(r=>r.json())
        .then(async data=>{
          if (!data.success){
            // KEY FIX: auto-advance if already claimed
            if ((data.error||'').toLowerCase().includes('already claimed')){
              await hydrateUserState();
              // fetch where the server thinks we are and jump
              const s = await fetch('/api/debug/user_state').then(x=>x.json()).catch(()=>null);
              if (s && s.current_page) advanceToPage(s.current_page);
              else advanceToPage(currentPage+1);
              return;
            }
            alert(data.error || 'Bonus failed');
            if (btn){ btn.disabled=false; btn.textContent = `Claim ${points}pt Completion Bonus`; }
            return;
          }
          userPoints = data.points || userPoints;
          document.getElementById('points').textContent = userPoints;
          if (btn){ btn.textContent='CLAIMED!'; btn.style.background='#28a745'; btn.style.animation='none'; }
          if (data.current_page) advanceToPage(data.current_page);
        })
        .catch(()=>{ alert('Flask unreachable'); if (btn){ btn.disabled=false; btn.textContent=`Claim ${points}pt Completion Bonus`; } });
    }

    // ---- navigation ----
    function advanceToPage(n){
      currentPage = Number(n) || 1;
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const target = document.getElementById('page'+currentPage);
      if (target) target.classList.add('active');

      const names = ['Basic Info','Mid-Tier Info','High-Value Info','Extreme Secrets','Data Protection Theater'];
      const stage = document.getElementById('currentStage');
      if (stage) stage.textContent = names[currentPage-1] || ('Page '+currentPage);

      const bar = document.getElementById('progressBar');
      if (bar) bar.style.width = ((currentPage/5)*100) + '%';

      // re-evaluate completion for this page with hydrated soldData
      setTimeout(checkPageCompletion, 100);
    }

    // ---- leaderboard ----
    function loadLeaderboard(){
      fetch('/api/leaderboard')
        .then(r=>r.json())
        .then(rows=>{
          const ul = document.getElementById('leaderboard');
          if (!ul) return;
          ul.innerHTML = '';
          if (!Array.isArray(rows) || rows.length===0){
            ul.innerHTML = '<li style="text-align:center;color:#666">No players yet</li>';
            return;
          }
          rows.forEach((u,i)=>{
            const li=document.createElement('li');
            const medal = i===0?'🥇':i===1?'🥈':i===2?'🥉':('#'+(i+1));
            li.innerHTML = `<span>${medal} <strong>${u.name}</strong>: ${Number(u.points||0).toLocaleString()} pts</span>`;
            ul.appendChild(li);
          });
        })
        .catch(()=>{ const ul=document.getElementById('leaderboard'); if (ul) ul.innerHTML='<li style="color:#dc3545;text-align:center">Failed to load leaderboard</li>'; });
    }

    // ---- session ping (optional) ----
    function trackSession(){
      const duration = Math.floor((new Date()-sessionStart)/1000);
      const pageId = document.querySelector('.page.active')?.id || 'page1';
      fetch('/api/session_data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({duration,pages_visited:pageId})}).catch(()=>{});
    }

    // ---- boot ----
    document.addEventListener('DOMContentLoaded', async ()=>{
      pingServer();
      setInterval(pingServer, 10000);
      setInterval(trackSession, 30000);

      // if session already exists, hydrate immediately (returning users)
      const who = await fetch('/api/debug/user_state').then(r=>r.ok?r.json():null).catch(()=>null);
      if (who && !who.error){
        document.getElementById('landing').style.display='none';
        document.getElementById('dashboard').classList.add('active');
        await hydrateUserState();
        advanceToPage(who.current_page || 1);
        loadLeaderboard();
      }
    });

    // expose simple debug helper
    window.goto = n => advanceToPage(Number(n));
  // unified data-button click handling (replaces inline onclicks)
  function handleDataBtnClick(e){
    const btn = e.target.closest('.data-btn');
    if (!btn) return;

    // if somebody left it disabled by mistake, try to re-enable after checking state
    if (btn.hasAttribute('disabled')) {
      // light check: if it’s in our sold set, keep disabled; else re-enable
      const t = btn.dataset.type;
      if (!soldData.has(t)) btn.removeAttribute('disabled');
      else return; // already sold
    }

    const type = btn.dataset.type;
    const label = btn.dataset.label || type;
    const points = Number(btn.dataset.points || 0);
    const needsInput = String(btn.dataset.needsInput || btn.getAttribute('data-needs-input') || 'false').toLowerCase() === 'true';

    const input = document.getElementById(type);
    const value = needsInput ? (input?.value || '').trim() : '';

    if (needsInput && !value){
      alert(`Please enter ${label}.`);
      return;
    }

    btn.setAttribute('disabled','disabled');

    fetch('/api/sell', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ type, value })
    })
    .then(r=>r.json())
    .then(data=>{
      if (!data.success){
        alert(data.error || 'Sell failed');
        btn.removeAttribute('disabled');
        return;
      }
      soldData.add(type);
      if (typeof data.points === 'number'){
        document.getElementById('points').textContent = data.points;
      }
      btn.textContent = 'Sold!';
      btn.style.background = '#ccc';
      checkPageCompletion();
    })
    .catch(()=>{
      alert('Connection error.');
      btn.removeAttribute('disabled');
    });
  }

  // bind once after DOMContentLoaded
  document.addEventListener('DOMContentLoaded', ()=>{
    document.addEventListener('click', (e)=>{
      if (e.target.closest('.data-btn')) handleDataBtnClick(e);
    });
  });

  // optional: make sure hydration can’t leave the wrong disabled state
  async function hydrateUserState(){
    try{
      const r = await fetch('/api/debug/user_state');
      if (!r.ok) return;
      const data = await r.json();
      if (data.error) return;

      document.getElementById('points').textContent = data.points;

      // reset all data buttons to enabled, then disable the sold ones
      document.querySelectorAll('.data-btn').forEach(b => b.removeAttribute('disabled'));

      (data.data_types_sold||[]).forEach(t=>{
        soldData.add(t);
        const b = document.querySelector(`.data-btn[data-type="${t}"]`);
        if (b){ b.setAttribute('disabled','disabled'); b.textContent='Sold!'; b.style.background='#ccc'; }
      });

      (data.bonuses_claimed||[]).forEach(b=>{
        const n = String(b.page).replace('page','');
        const btn = document.getElementById('bonus'+n);
        if (btn){ btn.disabled = true; btn.textContent='CLAIMED!'; btn.style.background='#28a745'; btn.style.animation='none'; }
      });
    }catch(_){}
  }

  function handleBonusBtnClick(e){
    const btn = e.target.closest('.bonus-btn');
    if (!btn) return;
  
    if (btn.hasAttribute('disabled')) return; // not ready or already claimed
  
    const page  = btn.dataset.bonusPage;        // e.g., "page3"
    const points = Number(btn.dataset.bonusPoints || 0);
  
    // optimistic disable to prevent double taps
    btn.setAttribute('disabled','disabled');
  
    fetch('/api/claim_bonus', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ page, points })
    })
    .then(r=>r.json())
    .then(async data=>{
      if (!data.success){
        // if server says already claimed, hydrate and advance
        const msg = (data.error || '').toLowerCase();
        if (msg.includes('already claimed')) {
          await hydrateUserState();
          const s = await fetch('/api/debug/user_state').then(x=>x.json()).catch(()=>null);
          if (s && s.current_page) advanceToPage(s.current_page);
          else advanceToPage(currentPage+1);
        } else {
          alert(data.error || 'Bonus claim failed');
          btn.removeAttribute('disabled');
          checkPageCompletion();
        }
        return;
      }
    
      if (typeof data.points === 'number'){
        document.getElementById('points').textContent = data.points;
      }
      btn.textContent = 'CLAIMED!';
      btn.style.background = '#28a745';
      btn.style.animation = 'none';
      // trust backend page pointer if provided, else move forward
      advanceToPage(data.current_page || (currentPage + 1));
    })
    .catch(()=>{
      alert('Flask unreachable while claiming bonus.');
      btn.removeAttribute('disabled');
      checkPageCompletion();
    });
  }
  
  // Bind once (you already bind data-btns similarly)
  document.addEventListener('DOMContentLoaded', ()=>{
    document.addEventListener('click', (e)=>{
      if (e.target.closest('.bonus-btn')) handleBonusBtnClick(e);
    });
  });
</script>
  </body>
</html>
